---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { buildSearchIndex, getBuiltInTopics, getTopicStats } from '../../lib/data';

const allNodes = await buildSearchIndex();
const topics = getBuiltInTopics();

// Get stats for each topic
const topicsWithStats = topics.map((topic) => ({
  ...topic,
  stats: getTopicStats(topic, allNodes),
}));

// Sort by total items descending
topicsWithStats.sort((a, b) => b.stats.total - a.stats.total);
---

<BaseLayout
  title="Topics"
  description="Explore curated topics covering the major areas of computing history and technology."
>
  <div class="topics-header">
    <h1>Explore Topics</h1>
    <p>
      Curated collections of related people, works, and institutions organized by major areas of computing.
    </p>
  </div>

  <div class="topics-grid">
    {topicsWithStats.map((topic) => (
      <a href={`/topics/${topic.slug}`} class="topic-card">
        <div class="topic-icon">{topic.icon}</div>
        <div class="topic-content">
          <h2>{topic.name}</h2>
          <p class="topic-description">{topic.description}</p>
          <div class="topic-stats">
            <span class="stat" title="People">
              <span class="dot people"></span>
              {topic.stats.people}
            </span>
            <span class="stat" title="Works">
              <span class="dot works"></span>
              {topic.stats.works}
            </span>
            <span class="stat" title="Institutions">
              <span class="dot institutions"></span>
              {topic.stats.institutions}
            </span>
            <span class="stat total">{topic.stats.total} total</span>
          </div>
          <div class="topic-domains">
            {topic.domains.slice(0, 3).map((domain) => (
              <span class="domain-pill">{domain}</span>
            ))}
            {topic.domains.length > 3 && (
              <span class="domain-pill more">+{topic.domains.length - 3}</span>
            )}
          </div>
        </div>
      </a>
    ))}
  </div>

  <div class="topics-footer">
    <p>
      Topics are auto-generated collections based on domain classifications.
      Looking for something specific? <a href="/browse">Browse all items</a> or explore the <a href="/graph">interactive graph</a>.
    </p>
  </div>
</BaseLayout>

<style>
  .topics-header {
    margin-bottom: 2rem;
    text-align: center;
  }

  .topics-header h1 {
    margin-bottom: 0.5rem;
  }

  .topics-header p {
    color: var(--color-muted);
    font-size: 1.1rem;
    max-width: 600px;
    margin: 0 auto;
  }

  .topics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.25rem;
    margin-bottom: 2rem;
  }

  .topic-card {
    display: flex;
    gap: 1rem;
    padding: 1.25rem;
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease;
  }

  .topic-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    border-color: #667eea;
    text-decoration: none;
  }

  .topic-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    font-size: 1.25rem;
    font-weight: 700;
    color: white;
    font-family: monospace;
    flex-shrink: 0;
  }

  .topic-content {
    flex: 1;
    min-width: 0;
  }

  .topic-content h2 {
    font-size: 1.1rem;
    margin-bottom: 0.25rem;
    line-height: 1.3;
  }

  .topic-description {
    font-size: 0.85rem;
    color: var(--color-muted);
    margin-bottom: 0.75rem;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .topic-stats {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-bottom: 0.75rem;
    font-size: 0.8rem;
  }

  .stat {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    color: var(--color-muted);
  }

  .dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .dot.people {
    background: #e74c3c;
  }

  .dot.works {
    background: #3498db;
  }

  .dot.institutions {
    background: #27ae60;
  }

  .stat.total {
    font-weight: 600;
    color: var(--color-text);
  }

  .topic-domains {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
  }

  .domain-pill {
    display: inline-block;
    padding: 0.125rem 0.5rem;
    background: var(--color-bg);
    border-radius: 4px;
    font-size: 0.7rem;
    color: var(--color-muted);
  }

  .domain-pill.more {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
  }

  .topics-footer {
    text-align: center;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border);
  }

  .topics-footer p {
    color: var(--color-muted);
    font-size: 0.9rem;
  }

  .topics-footer a {
    color: var(--color-link);
  }

  @media (max-width: 600px) {
    .topics-grid {
      grid-template-columns: 1fr;
    }

    .topic-card {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .topic-stats {
      justify-content: center;
    }

    .topic-domains {
      justify-content: center;
    }
  }
</style>
