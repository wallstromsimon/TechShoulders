---
import BaseLayout from '../../layouts/BaseLayout.astro';
import NodeHeader from '../../components/NodeHeader.astro';
import NodeAttribution from '../../components/NodeAttribution.astro';
import NodeLinks from '../../components/NodeLinks.astro';
import { getAllNodeIds, findNodeById, type PersonEntry, type WorkEntry, type InstitutionEntry } from '../../lib/data';

export async function getStaticPaths() {
  const ids = await getAllNodeIds();
  return ids.map(id => ({ params: { id } }));
}

const { id } = Astro.params;
const result = await findNodeById(id);

if (!result) {
  return Astro.redirect('/404');
}

const { kind, entry } = result;
const { Content } = await entry.render();

// Build meta string based on kind
let meta = '';
if (kind === 'people') {
  const person = entry as PersonEntry;
  meta = person.data.era;
} else if (kind === 'works') {
  const work = entry as WorkEntry;
  meta = `${work.data.kind} · ${work.data.year}`;
} else if (kind === 'institutions') {
  const inst = entry as InstitutionEntry;
  meta = inst.data.kind;
  if (inst.data.location) {
    meta += ` · ${inst.data.location}`;
  }
}
---

<BaseLayout title={entry.data.name}>
  <NodeHeader
    name={entry.data.name}
    kind={kind}
    meta={meta}
    image={entry.data.image}
  />

  <article class="content">
    <Content />
  </article>

  {kind === 'people' && (entry as PersonEntry).data.signatureWorks && (
    <section class="signature-works">
      <h3>Signature Works</h3>
      <ul>
        {(entry as PersonEntry).data.signatureWorks!.map(workId => (
          <li><a href={`/node/${workId}`}>{workId}</a></li>
        ))}
      </ul>
    </section>
  )}

  {kind === 'people' && (entry as PersonEntry).data.whyYouCare && (
    <section class="why-care">
      <h3>Why You Should Care</h3>
      <ul>
        {(entry as PersonEntry).data.whyYouCare!.map(reason => (
          <li>{reason}</li>
        ))}
      </ul>
    </section>
  )}

  <NodeLinks links={entry.data.links} />

  {entry.data.image && <NodeAttribution image={entry.data.image} />}
</BaseLayout>

<style>
  .content {
    margin-top: 1.5rem;
  }

  .content :global(p) {
    margin-bottom: 1rem;
  }

  .signature-works,
  .why-care {
    margin-top: 1.5rem;
  }

  .signature-works h3,
  .why-care h3 {
    font-size: 1rem;
    margin-bottom: 0.5rem;
  }

  .signature-works ul,
  .why-care ul {
    list-style: disc;
    padding-left: 1.5rem;
    margin: 0;
  }
</style>
