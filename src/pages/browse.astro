---
import BaseLayout from '../layouts/BaseLayout.astro';
import NodeCard from '../components/NodeCard.astro';
import { loadAll, buildSearchIndex, getAllDomains, getAllEras, type NodeKind } from '../lib/data';

const nodes = await buildSearchIndex();
const allDomains = getAllDomains(nodes);
const allEras = getAllEras(nodes);
const { people, works, institutions } = await loadAll();

// Combine all entries with their kind
const allEntries = [
  ...people.map(e => ({ entry: e, kind: 'people' as NodeKind })),
  ...works.map(e => ({ entry: e, kind: 'works' as NodeKind })),
  ...institutions.map(e => ({ entry: e, kind: 'institutions' as NodeKind })),
].sort((a, b) => a.entry.data.name.localeCompare(b.entry.data.name));
---

<BaseLayout title="Browse">
  <div class="browse-header">
    <h1>Browse Collection</h1>
    <p>Explore the people, works, and institutions that shaped modern technology.</p>
  </div>

  <div class="search-section">
    <div class="search-box">
      <input
        type="text"
        id="search-input"
        placeholder="Search by name, domain, or keyword..."
        autocomplete="off"
      />
      <div id="search-results" class="search-results" hidden></div>
    </div>
  </div>

  <div class="filters">
    <div class="filter-group">
      <label for="filter-kind">Type</label>
      <select id="filter-kind">
        <option value="">All Types</option>
        <option value="people">People</option>
        <option value="works">Works</option>
        <option value="institutions">Institutions</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="filter-domain">Domain</label>
      <select id="filter-domain">
        <option value="">All Domains</option>
        {allDomains.map(domain => (
          <option value={domain}>{domain}</option>
        ))}
      </select>
    </div>

    <div class="filter-group">
      <label for="filter-era">Era</label>
      <select id="filter-era">
        <option value="">All Eras</option>
        {allEras.map(era => (
          <option value={era}>{era}</option>
        ))}
      </select>
    </div>

    <button id="clear-filters" class="clear-btn">Clear Filters</button>
  </div>

  <div class="stats">
    <span id="result-count">{allEntries.length} items</span>
  </div>

  <div class="card-grid" id="card-grid">
    {allEntries.map(({ entry, kind }) => (
      <div
        class="grid-item"
        data-id={entry.data.id}
        data-kind={kind}
        data-domains={JSON.stringify(
          kind === 'people'
            ? (entry.data as any).domains || []
            : kind === 'works'
            ? (entry.data as any).domains || []
            : []
        )}
        data-era={kind === 'people' ? (entry.data as any).era : ''}
      >
        <NodeCard entry={entry} kind={kind} />
      </div>
    ))}
  </div>

  <div id="no-results" class="no-results" hidden>
    <p>No items match your filters.</p>
    <button id="reset-filters">Reset Filters</button>
  </div>
</BaseLayout>

<script>
  // Fetch search index and initialize Fuse.js
  Promise.all([
    fetch('/search-index.json').then(r => r.json()),
    // @ts-ignore - CDN import
    import('https://cdn.jsdelivr.net/npm/fuse.js@7.1.0/dist/fuse.mjs')
  ]).then(([searchIndex, { default: Fuse }]: [any, { default: any }]) => {
    const fuse = new Fuse(searchIndex, {
      keys: [
        { name: 'name', weight: 2 },
        { name: 'subtitle', weight: 1 },
        { name: 'domains', weight: 1.5 },
        { name: 'era', weight: 0.5 },
        { name: 'location', weight: 0.5 },
      ],
      threshold: 0.3,
      includeMatches: true,
    });

    const searchInput = document.getElementById('search-input') as HTMLInputElement | null;
    const searchResults = document.getElementById('search-results');
    const cardGrid = document.getElementById('card-grid');
    const filterKind = document.getElementById('filter-kind') as HTMLSelectElement | null;
    const filterDomain = document.getElementById('filter-domain') as HTMLSelectElement | null;
    const filterEra = document.getElementById('filter-era') as HTMLSelectElement | null;
    const clearBtn = document.getElementById('clear-filters');
    const resultCount = document.getElementById('result-count');
    const noResults = document.getElementById('no-results');
    const resetBtn = document.getElementById('reset-filters');

    if (!searchInput || !searchResults || !cardGrid || !filterKind || !filterDomain || !filterEra || !clearBtn || !resultCount || !noResults || !resetBtn) {
      return;
    }

    let currentSearchTerm = '';

    // Search functionality
    searchInput.addEventListener('input', () => {
      const query = searchInput.value.trim();
      currentSearchTerm = query;

      if (query.length < 2) {
        searchResults.hidden = true;
        applyFilters();
        return;
      }

      const results = fuse.search(query).slice(0, 8);

      if (results.length === 0) {
        searchResults.innerHTML = '<div class="search-result-item empty">No results found</div>';
        searchResults.hidden = false;
        return;
      }

      searchResults.innerHTML = results.map((result: any) => {
        const item = result.item;
        const kindClass = `kind-${item.kind}`;
        const kindLabel = item.kind === 'people' ? 'Person' : item.kind === 'works' ? 'Work' : 'Institution';
        return `
          <a href="/node/${item.id}" class="search-result-item ${kindClass}">
            <span class="result-badge">${kindLabel}</span>
            <span class="result-name">${item.name}</span>
            ${item.subtitle ? `<span class="result-subtitle">${item.subtitle}</span>` : ''}
          </a>
        `;
      }).join('');

      searchResults.hidden = false;
      applyFilters();
    });

    // Close search results when clicking outside
    document.addEventListener('click', (e) => {
      const target = e.target as Node | null;
      if (target && !searchInput.contains(target) && !searchResults.contains(target)) {
        searchResults.hidden = true;
      }
    });

    // Focus shows results again
    searchInput.addEventListener('focus', () => {
      if (currentSearchTerm.length >= 2) {
        searchResults.hidden = false;
      }
    });

    // Filter functionality
    function applyFilters() {
      const kindFilter = filterKind!.value;
      const domainFilter = filterDomain!.value;
      const eraFilter = filterEra!.value;

      const gridItems = cardGrid!.querySelectorAll<HTMLElement>('.grid-item');
      let visibleCount = 0;

      // Get search match IDs if there's a search term
      let searchMatchIds: Set<string> | null = null;
      if (currentSearchTerm.length >= 2) {
        const results = fuse.search(currentSearchTerm);
        searchMatchIds = new Set(results.map((r: any) => r.item.id));
      }

      gridItems.forEach(item => {
        const kind = item.dataset.kind;
        const domains = JSON.parse(item.dataset.domains || '[]');
        const era = item.dataset.era;
        const id = item.dataset.id;

        let visible = true;

        // Search filter
        if (searchMatchIds && !searchMatchIds.has(id || '')) {
          visible = false;
        }

        // Kind filter
        if (visible && kindFilter && kind !== kindFilter) {
          visible = false;
        }

        // Domain filter
        if (visible && domainFilter && !domains.includes(domainFilter)) {
          visible = false;
        }

        // Era filter
        if (visible && eraFilter && era !== eraFilter) {
          visible = false;
        }

        item.style.display = visible ? '' : 'none';
        if (visible) visibleCount++;
      });

      resultCount!.textContent = `${visibleCount} item${visibleCount !== 1 ? 's' : ''}`;
      noResults!.hidden = visibleCount > 0;
      cardGrid!.hidden = visibleCount === 0;
    }

    filterKind.addEventListener('change', applyFilters);
    filterDomain.addEventListener('change', applyFilters);
    filterEra.addEventListener('change', applyFilters);

    // Handle URL query parameters
    const urlParams = new URLSearchParams(window.location.search);
    const domainParam = urlParams.get('domain');
    if (domainParam) {
      filterDomain.value = domainParam;
      applyFilters();
    }

    function clearAllFilters() {
      filterKind!.value = '';
      filterDomain!.value = '';
      filterEra!.value = '';
      searchInput!.value = '';
      currentSearchTerm = '';
      searchResults!.hidden = true;
      applyFilters();
    }

    clearBtn.addEventListener('click', clearAllFilters);
    resetBtn.addEventListener('click', clearAllFilters);
  });
</script>

<style>
  .browse-header {
    margin-bottom: 2rem;
  }

  .browse-header h1 {
    margin-bottom: 0.5rem;
  }

  .browse-header p {
    color: var(--color-muted);
    margin: 0;
  }

  .search-section {
    margin-bottom: 1.5rem;
  }

  .search-box {
    position: relative;
  }

  #search-input {
    width: 100%;
    padding: 0.875rem 1rem;
    font-size: 1rem;
    border: 2px solid var(--color-border);
    border-radius: 8px;
    background: var(--color-card-bg);
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  #search-input:focus {
    outline: none;
    border-color: var(--color-link);
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
  }

  #search-input::placeholder {
    color: var(--color-muted);
  }

  .search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    margin-top: 4px;
    z-index: 100;
    max-height: 400px;
    overflow-y: auto;
  }

  .search-result-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    text-decoration: none;
    color: inherit;
    border-bottom: 1px solid var(--color-border);
    transition: background 0.15s ease;
  }

  .search-result-item:last-child {
    border-bottom: none;
  }

  .search-result-item:hover {
    background: var(--color-bg);
  }

  .search-result-item.empty {
    color: var(--color-muted);
    font-style: italic;
    cursor: default;
  }

  .result-badge {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    padding: 0.125rem 0.375rem;
    border-radius: 3px;
    flex-shrink: 0;
  }

  .kind-people .result-badge {
    background: #fce4e4;
    color: #c0392b;
  }

  .kind-works .result-badge {
    background: #e3f2fd;
    color: #1565c0;
  }

  .kind-institutions .result-badge {
    background: #e8f5e9;
    color: #2e7d32;
  }

  .result-name {
    font-weight: 500;
  }

  .result-subtitle {
    color: var(--color-muted);
    font-size: 0.85rem;
    margin-left: auto;
  }

  .filters {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: flex-end;
    margin-bottom: 1rem;
    padding: 1rem;
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
    border-radius: 8px;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex: 1;
    min-width: 140px;
  }

  .filter-group label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--color-muted);
    letter-spacing: 0.05em;
  }

  .filter-group select {
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    background: var(--color-bg);
    cursor: pointer;
  }

  .filter-group select:focus {
    outline: none;
    border-color: var(--color-link);
  }

  .clear-btn {
    padding: 0.5rem 1rem;
    font-size: 0.85rem;
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    cursor: pointer;
    color: var(--color-muted);
    transition: all 0.15s ease;
  }

  .clear-btn:hover {
    background: var(--color-bg);
    color: var(--color-text);
  }

  .stats {
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: var(--color-muted);
  }

  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.25rem;
  }

  .no-results {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--color-muted);
  }

  .no-results p {
    margin-bottom: 1rem;
  }

  #reset-filters {
    padding: 0.5rem 1.5rem;
    font-size: 0.9rem;
    background: var(--color-link);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s ease;
  }

  #reset-filters:hover {
    background: #0052a3;
  }

  @media (max-width: 600px) {
    .filters {
      flex-direction: column;
    }

    .filter-group {
      width: 100%;
    }

    .card-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
